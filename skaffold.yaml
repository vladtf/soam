apiVersion: skaffold/v4beta6
kind: Config
metadata:
  name: soam
build:
  local:
    push: false
  tagPolicy:
    envTemplate:
      template: "{{.IMAGE_NAME}}:latest"
  artifacts:
    - image: mosquitto
      context: mosquitto
      docker:
        pullParent: false
    - image: simulator
      context: simulator
      docker:
        pullParent: false
    - image: frontend
      context: frontend
      docker:
        pullParent: false
    - image: backend
      context: backend
      docker:
        pullParent: false
    - image: ingestor
      context: ingestor
      docker:
        pullParent: false
    - image: spark
      context: spark
      docker:
        pullParent: false
    - image: grafana
      context: grafana
      docker:
        pullParent: false
    - image: prometheus
      context: prometheus
      docker:
        pullParent: false
manifests:
  rawYaml:
    - k8s/*.yaml
deploy:
  kubectl:
    hooks:
      before:
        - host:
            command: ["pwsh", "-c", "./utils/cleanup-images.ps1"]
  helm:
    releases:
      - name: soam
        remoteChart: oci://registry-1.docker.io/bitnamicharts/spark
        version: 6.3.16
        valuesFiles:
          - spark-values.yaml
portForward:
  - resourceType: service
    resourceName: soam-spark-master-svc
    namespace: default
    port: 80
    localPort: 8080
  - resourceType: service
    resourceName: frontend
    namespace: default
    port: 3000
    localPort: 3000
  - resourceType: service
    resourceName: backend-external
    namespace: default
    port: 8000
    localPort: 8000
  - resourceType: service
    resourceName: ingestor
    namespace: default
    port: 8001
    localPort: 8001
  - resourceType: service
    resourceName: neo4j
    namespace: default
    port: 7474
    localPort: 7474
  - resourceType: service
    resourceName: minio
    namespace: default
    port: 9090
    localPort: 9090  
  - resourceType: service
    resourceName: minio
    namespace: default
    port: 9000
    localPort: 9000

# Uncomment the following lines to enable port forwarding for Grafana and Prometheus
  # - resourceType: service
  #   resourceName: grafana
  #   namespace: default
  #   port: 3000
  #   localPort: 3001
  # - resourceType: service
  #   resourceName: prometheus
  #   namespace: default
  #   port: 9090
  #   localPort: 9091
