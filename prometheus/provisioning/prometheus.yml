global:
  scrape_interval: 15s

scrape_configs:
  # container stats
  - job_name: cadvisor
    static_configs:
      - targets: ['cadvisor:8080']

  # spark master & workers (built-in)
  # - job_name: spark
  #   metrics_path: /metrics/
  #   static_configs:
  #     - targets: ['spark-master:8080', 'spark-worker:8081', 'spark-worker-2:8082']

  # MinIO (optional)
  # docker run -d --name minio-exporter --net soam_default minio/prometheus-exporter
  - job_name: minio
    scheme: http
    metrics_path: /minio/v2/metrics/cluster
    static_configs:
      - targets: [ 'minio:9000' ]

  # Mosquitto (optional) â€“ needs exporter sidecar
  # - job_name: mosquitto
  #   static_configs:
  #     - targets: ['mosquitto-exporter:9234']

  # Ingestor metrics - uses Kubernetes pod discovery to scrape all scaled pods
  - job_name: ingestor
    metrics_path: /api/metrics
    kubernetes_sd_configs:
      - role: pod
        namespaces:
          names: ['default', 'soam']  # Support both local (default) and AKS (soam) namespaces
    relabel_configs:
      # Only keep pods with label app=ingestor
      - source_labels: [__meta_kubernetes_pod_label_app]
        regex: ingestor
        action: keep
      # Use pod IP and port 8001 as target
      - source_labels: [__meta_kubernetes_pod_ip]
        target_label: __address__
        replacement: ${1}:8001
      # Add pod name as label for identification
      - source_labels: [__meta_kubernetes_pod_name]
        target_label: pod
      # Add node name for debugging
      - source_labels: [__meta_kubernetes_pod_node_name]
        target_label: node

  # Backend metrics - uses Kubernetes pod discovery for consistency
  - job_name: backend
    metrics_path: /api/metrics
    kubernetes_sd_configs:
      - role: pod
        namespaces:
          names: ['default', 'soam']  # Support both local (default) and AKS (soam) namespaces
    relabel_configs:
      # Only keep pods with label app=backend
      - source_labels: [__meta_kubernetes_pod_label_app]
        regex: backend
        action: keep
      # Use pod IP and port 8000 as target
      - source_labels: [__meta_kubernetes_pod_ip]
        target_label: __address__
        replacement: ${1}:8000
      # Add pod name as label for identification
      - source_labels: [__meta_kubernetes_pod_name]
        target_label: pod
      # Add node name for debugging
      - source_labels: [__meta_kubernetes_pod_node_name]
        target_label: node
