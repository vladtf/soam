# =============================================================================
# Stage 2: Deploy Application (Images + Kubernetes Resources)
# =============================================================================
# Builds all Docker images, pushes to ACR, and deploys Kubernetes resources:
#   - Builds and pushes all service images
#   - Deploys all K8s resources via Terraform
# =============================================================================

name: "2ï¸âƒ£ Deploy Application"

on:
  workflow_dispatch:
    inputs:
      skip_image_build:
        description: 'Skip building images (use existing)'
        required: false
        default: false
        type: boolean

env:
  AZURE_RESOURCE_GROUP: soam-rg
  AKS_CLUSTER_NAME: soam-aks-cluster
  KUBERNETES_NAMESPACE: soam
  TF_STEP1_DIR: terraform/01-azure-infrastructure
  TF_STEP2_DIR: terraform/02-kubernetes-resources

jobs:
  # ===========================================================================
  # Get Infrastructure Info
  # ===========================================================================
  get-infra:
    name: Get Infrastructure Info
    runs-on: ubuntu-latest
    outputs:
      acr_login_server: ${{ steps.info.outputs.acr_login_server }}
      acr_name: ${{ steps.info.outputs.acr_name }}
      aks_host: ${{ steps.info.outputs.aks_host }}
      aks_ca_cert: ${{ steps.info.outputs.aks_ca_cert }}
      aks_client_cert: ${{ steps.info.outputs.aks_client_cert }}
      aks_client_key: ${{ steps.info.outputs.aks_client_key }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false
      
      - name: Get Terraform Outputs
        id: info
        working-directory: ${{ env.TF_STEP1_DIR }}
        run: |
          # Get storage account name
          SUB_ID=$(az account show --query id -o tsv)
          STORAGE_NAME="soamtfstate$(echo $SUB_ID | cut -c1-8)"
          
          terraform init \
            -backend-config="resource_group_name=soam-tfstate-rg" \
            -backend-config="storage_account_name=$STORAGE_NAME" \
            -backend-config="container_name=tfstate" \
            -backend-config="key=01-infrastructure.tfstate"
          
          echo "acr_login_server=$(terraform output -raw acr_login_server)" >> $GITHUB_OUTPUT
          echo "acr_name=$(terraform output -raw acr_name)" >> $GITHUB_OUTPUT
          echo "aks_host=$(terraform output -raw aks_host)" >> $GITHUB_OUTPUT
          echo "aks_ca_cert=$(terraform output -raw aks_cluster_ca_certificate)" >> $GITHUB_OUTPUT
          echo "aks_client_cert=$(terraform output -raw aks_client_certificate)" >> $GITHUB_OUTPUT
          echo "aks_client_key=$(terraform output -raw aks_client_key)" >> $GITHUB_OUTPUT

  # ===========================================================================
  # Build and Push Images
  # ===========================================================================
  build-images:
    name: Build ${{ matrix.image }}
    runs-on: ubuntu-latest
    needs: get-infra
    if: github.event.inputs.skip_image_build != 'true'
    strategy:
      fail-fast: false
      matrix:
        image: [backend, frontend, ingestor, spark, simulator, rest-api-simulator, mosquitto, grafana, prometheus]
    steps:
      - uses: actions/checkout@v4
      
      - name: Check if directory exists
        id: check
        run: |
          if [ -d "${{ matrix.image }}" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Set up Docker Buildx
        if: steps.check.outputs.exists == 'true'
        uses: docker/setup-buildx-action@v3
      
      - name: Azure Login
        if: steps.check.outputs.exists == 'true'
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Login to ACR
        if: steps.check.outputs.exists == 'true'
        run: az acr login --name ${{ needs.get-infra.outputs.acr_name }}
      
      - name: Build and push
        if: steps.check.outputs.exists == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.image }}
          push: true
          tags: |
            ${{ needs.get-infra.outputs.acr_login_server }}/${{ matrix.image }}:latest
            ${{ needs.get-infra.outputs.acr_login_server }}/${{ matrix.image }}:${{ github.sha }}
          cache-from: type=registry,ref=${{ needs.get-infra.outputs.acr_login_server }}/${{ matrix.image }}:buildcache
          cache-to: type=registry,ref=${{ needs.get-infra.outputs.acr_login_server }}/${{ matrix.image }}:buildcache,mode=max

  # ===========================================================================
  # Deploy Kubernetes Resources
  # ===========================================================================
  deploy-k8s:
    name: Deploy Kubernetes Resources
    runs-on: ubuntu-latest
    needs: [get-infra, build-images]
    if: always() && (needs.build-images.result == 'success' || needs.build-images.result == 'skipped')
    steps:
      - uses: actions/checkout@v4
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
      
      - name: Create tfvars
        working-directory: ${{ env.TF_STEP2_DIR }}
        run: |
          cat > terraform.tfvars << EOF
          aks_host                   = "${{ needs.get-infra.outputs.aks_host }}"
          aks_client_certificate     = "${{ needs.get-infra.outputs.aks_client_cert }}"
          aks_client_key             = "${{ needs.get-infra.outputs.aks_client_key }}"
          aks_cluster_ca_certificate = "${{ needs.get-infra.outputs.aks_ca_cert }}"
          acr_login_server           = "${{ needs.get-infra.outputs.acr_login_server }}"
          kubernetes_namespace       = "${{ env.KUBERNETES_NAMESPACE }}"
          deploy_monitoring          = true
          EOF
      
      - name: Terraform Init
        working-directory: ${{ env.TF_STEP2_DIR }}
        run: |
          SUB_ID=$(az account show --query id -o tsv)
          STORAGE_NAME="soamtfstate$(echo $SUB_ID | cut -c1-8)"
          
          terraform init \
            -backend-config="resource_group_name=soam-tfstate-rg" \
            -backend-config="storage_account_name=$STORAGE_NAME" \
            -backend-config="container_name=tfstate" \
            -backend-config="key=02-kubernetes.tfstate"
      
      - name: Terraform Apply
        working-directory: ${{ env.TF_STEP2_DIR }}
        run: terraform apply -auto-approve
      
      - name: Get AKS credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.AKS_CLUSTER_NAME }} \
            --overwrite-existing
      
      - name: Verify deployment
        run: |
          echo "ðŸ“Š Pod Status:"
          kubectl get pods -n ${{ env.KUBERNETES_NAMESPACE }}
          echo ""
          echo "ðŸ“Š Services:"
          kubectl get svc -n ${{ env.KUBERNETES_NAMESPACE }}
      
      - name: Summary
        working-directory: ${{ env.TF_STEP2_DIR }}
        run: |
          # Get URLs from Terraform outputs
          FRONTEND_URL=$(terraform output -raw frontend_url 2>/dev/null || echo "N/A")
          BACKEND_URL=$(terraform output -raw backend_url 2>/dev/null || echo "N/A")
          BACKEND_DOCS_URL=$(terraform output -raw backend_docs_url 2>/dev/null || echo "N/A")
          INGESTOR_URL=$(terraform output -raw ingestor_url 2>/dev/null || echo "N/A")
          GRAFANA_URL=$(terraform output -raw grafana_url 2>/dev/null || echo "N/A")
          
          echo "## âœ… Application Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒ Service URLs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| **Frontend** | $FRONTEND_URL |" >> $GITHUB_STEP_SUMMARY
          echo "| **Backend API** | $BACKEND_URL |" >> $GITHUB_STEP_SUMMARY
          echo "| **Backend Docs** | $BACKEND_DOCS_URL |" >> $GITHUB_STEP_SUMMARY
          echo "| **Ingestor** | $INGESTOR_URL |" >> $GITHUB_STEP_SUMMARY
          echo "| **Grafana** | $GRAFANA_URL |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Pod Status" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n ${{ env.KUBERNETES_NAMESPACE }} >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
